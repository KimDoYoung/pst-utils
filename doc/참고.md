# ì°¸ê³ 

```python
import pypff
import sys
import os

# MAPI ì†ì„± ìƒìˆ˜
PR_MESSAGE_CLASS = 0x001A  # 26 in decimal

def get_message_class(msg: pypff.message) -> str:
    """
    pypff 3.12 íœ ì—ì„œ message_classë¥¼ ì˜¬ë°”ë¥´ê²Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
    """
    # ë°©ë²• 1: ì§ì ‘ ì†ì„± ì ‘ê·¼ (ì¼ë¶€ ë²„ì „ì—ì„œ ì‘ë™)
    try:
        if hasattr(msg, 'message_class') and msg.message_class:
            return msg.message_class
    except Exception:
        pass
    
    # ë°©ë²• 2: get_message_class ë©”ì„œë“œ (êµ¬ ë²„ì „)
    try:
        if hasattr(msg, 'get_message_class'):
            mc = msg.get_message_class()
            if mc:
                return mc
    except Exception:
        pass
    
    # ë°©ë²• 3: record_setsë¥¼ í†µí•œ ì ‘ê·¼ (3.12 íœ ì—ì„œ ì‘ë™í•˜ëŠ” ë°©ë²•)
    try:
        if hasattr(msg, 'record_sets') and msg.record_sets:
            # record_setsëŠ” pypff._record_sets íƒ€ì…
            for record_set in msg.record_sets:
                if hasattr(record_set, 'entries'):
                    # entriesëŠ” pypff.record_entries íƒ€ì…
                    for entry in record_set.entries:
                        # entry_typeì´ 26 (PR_MESSAGE_CLASS)ì¸ ê²ƒì„ ì°¾ê¸°
                        if (hasattr(entry, 'entry_type') and 
                            entry.entry_type == PR_MESSAGE_CLASS):
                            
                            # data_as_string() ë©”ì„œë“œ ì‚¬ìš©
                            if hasattr(entry, 'data_as_string'):
                                try:
                                    return entry.data_as_string
                                except Exception:
                                    pass
                            
                            # ë°±ì—…: ì§ì ‘ data ë””ì½”ë”©
                            if hasattr(entry, 'data') and entry.data:
                                try:
                                    # value_typeì´ 31ì´ë©´ UTF-16LE, 30ì´ë©´ CP1252
                                    if hasattr(entry, 'value_type'):
                                        if entry.value_type == 31:  # PT_UNICODE
                                            return entry.data.decode('utf-16-le', 'replace').rstrip('\x00')
                                        elif entry.value_type == 30:  # PT_STRING8
                                            return entry.data.decode('cp1252', 'replace').rstrip('\x00')
                                except Exception:
                                    pass
    except Exception as e:
        print(f"Warning: Error in record_sets access: {e}")
    
    return ""

def is_email_message(msg: pypff.message) -> bool:
    """
    ë©”ì‹œì§€ê°€ ì´ë©”ì¼ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    """
    msg_class = get_message_class(msg)
    if not msg_class:
        return False
    
    # IPM.Noteë¡œ ì‹œì‘í•˜ëŠ” ë©”ì‹œì§€ í´ë˜ìŠ¤ëŠ” ì´ë©”ì¼
    return msg_class.upper().startswith("IPM.NOTE")

def extract_email_info(msg: pypff.message) -> dict:
    """
    ì´ë©”ì¼ ë©”ì‹œì§€ì—ì„œ ê¸°ë³¸ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    """
    info = {
        'identifier': getattr(msg, 'identifier', None),
        'subject': '',
        'sender': '',
        'delivery_time': '',
        'message_class': get_message_class(msg),
        'has_attachments': False
    }
    
    # ì œëª©
    try:
        info['subject'] = getattr(msg, 'subject', '') or ''
    except Exception:
        pass
    
    # ë°œì‹ ì
    try:
        info['sender'] = getattr(msg, 'sender_name', '') or ''
    except Exception:
        pass
    
    # ì „ë‹¬ ì‹œê°„
    try:
        delivery_time = getattr(msg, 'delivery_time', None)
        if delivery_time:
            info['delivery_time'] = str(delivery_time)
    except Exception:
        pass
    
    # ì²¨ë¶€íŒŒì¼ ì—¬ë¶€ (ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆì§€ë§Œ ì‹œë„)
    try:
        num_attachments = getattr(msg, 'number_of_attachments', 0)
        info['has_attachments'] = num_attachments > 0
    except Exception:
        pass
    
    return info

def walk_folders(folder: pypff.folder, max_emails: int = 1000, depth: int = 0) -> int:
    """
    í´ë”ë¥¼ ìˆœíšŒí•˜ë©° ì´ë©”ì¼ ë©”ì‹œì§€ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    """
    email_count = 0
    
    try:
        # í˜„ì¬ í´ë”ì˜ ë©”ì‹œì§€ ì²˜ë¦¬
        if hasattr(folder, 'sub_messages'):
            for msg in folder.sub_messages:
                if email_count >= max_emails:
                    return email_count
                
                try:
                    msg_class = get_message_class(msg)
                    if msg_class.upper().startswith("IPM.NOTE"):
                        email_info = extract_email_info(msg)
                        
                        # ì¶œë ¥
                        indent = "  " * depth
                        print(f"{indent}[{email_info['identifier']}] {email_info['subject']}")
                        print(f"{indent}  Class: {msg_class}")
                        print(f"{indent}  From: {email_info['sender']}")
                        print(f"{indent}  Time: {email_info['delivery_time']}")
                        print()
                        
                        email_count += 1
                        
                except Exception as e:
                    print(f"Warning: Error processing message: {e}")
                    continue
        
        # í•˜ìœ„ í´ë” ìˆœíšŒ
        if hasattr(folder, 'sub_folders'):
            for sub_folder in folder.sub_folders:
                if email_count >= max_emails:
                    break
                
                try:
                    folder_name = getattr(sub_folder, 'name', 'Unknown')
                    print(f"{'  ' * depth}ğŸ“ {folder_name}")
                    
                    sub_count = walk_folders(sub_folder, max_emails - email_count, depth + 1)
                    email_count += sub_count
                    
                    if email_count >= max_emails:
                        break
                        
                except Exception as e:
                    print(f"Warning: Error processing subfolder: {e}")
                    continue
                    
    except Exception as e:
        print(f"Error walking folder at depth {depth}: {e}")
    
    return email_count

def extract_emails_from_pst(pst_path: str, max_emails: int = 1000) -> int:
    """
    PST íŒŒì¼ì—ì„œ ì´ë©”ì¼ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
    """
    if not os.path.exists(pst_path):
        raise FileNotFoundError(f"PST file not found: {pst_path}")
    
    pf = None
    
    try:
        pf = pypff.file()
        pf.open(pst_path)
        
        root_folder = pf.get_root_folder()
        if not root_folder:
            raise ValueError("Cannot access root folder")
        
        print(f"ğŸ“§ Extracting emails from: {pst_path}")
        print(f"ğŸ“Š Maximum emails to extract: {max_emails}")
        print("=" * 60)
        
        total_emails = walk_folders(root_folder, max_emails)
        
        print("=" * 60)
        print(f"âœ… Total emails extracted: {total_emails}")
        
        return total_emails
        
    except Exception as e:
        print(f"Error processing PST file: {e}")
        raise
    finally:
        if pf:
            pf.close()

# ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ìš© í•¨ìˆ˜
def test_message_class_extraction(pst_path: str, max_test: int = 10):
    """
    ë©”ì‹œì§€ í´ë˜ìŠ¤ ì¶”ì¶œì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
    """
    pf = pypff.file()
    pf.open(pst_path)
    
    root_folder = pf.get_root_folder()
    test_count = 0
    
    print("ğŸ” Testing message class extraction:")
    print("-" * 40)
    
    for msg in root_folder.sub_messages:
        if test_count >= max_test:
            break
            
        msg_class = get_message_class(msg)
        subject = getattr(msg, 'subject', 'No subject')
        
        print(f"Message {test_count + 1}:")
        print(f"  Subject: {subject[:50]}...")
        print(f"  Class: '{msg_class}'")
        print(f"  Is Email: {msg_class.upper().startswith('IPM.NOTE')}")
        print()
        
        test_count += 1
    
    pf.close()

# ë©”ì¸ ì‹¤í–‰
if __name__ == "__main__":
    pst_path = "/mnt/c/tmp/2021.pst"
    max_emails = 1000
    
    if not os.path.exists(pst_path):
        print(f"âŒ PST file not found: {pst_path}")
        sys.exit(1)
    
    try:
        # ë¨¼ì € í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        print("ğŸ§ª Running test...")
        test_message_class_extraction(pst_path, 5)
        
        print("\n" + "=" * 60)
        
        # ì‹¤ì œ ì¶”ì¶œ ì‹¤í–‰
        total = extract_emails_from_pst(pst_path, max_emails)
        
        print(f"\nğŸ‰ Successfully processed {total} emails!")
        
    except Exception as e:
        print(f"âŒ Error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
```        